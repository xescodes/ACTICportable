<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta ver="1.15">
    <title>Qüestionari Interactiu</title>
    <link rel="icon" href="data:," type="image/x-icon">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
        }
        h1 {
            color: #333;
        }
        .question {
            margin-bottom: 20px;
        }
        .options label {
            display: block;
            margin-bottom: 5px;
        }
        .result {
            margin-top: 10px;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
        .explanation {
            margin-top: 5px;
            color: #666;
        }
        .btn-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .login-modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .login-form {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .progress-chart {
            margin-top: 20px;
        }
        .bold {
            font-weight: bold;
        }
        .red {
            color: red;
        }
        .brown {
            color: brown;
        }
        .green {
            color: green;
        }
    </style>
</head>
<body>
    <h1>Qüestionari Interactiu</h1>
    <div class="btn-container">
        <button id="login-btn">Iniciar Sessió</button>
        <button id="show-progress-btn">Mostrar Progrés</button>
        <button id="refresh-btn">Refrescar Pàgina</button>
    </div>
    <div id="loading">Carregant...</div>
    <div id="quiz-container" style="display: none;"></div>
    <button id="submit-btn" style="display: none;">Verificar Respostes</button>
    <div id="results"></div>
    <div id="progress-chart" class="progress-chart" style="display: none;">
        <canvas id="progressChart"></canvas>
    </div>

    <!-- Modal per iniciar sessió -->
    <div id="login-modal" class="login-modal">
        <div class="login-form">
            <h2>Iniciar Sessió</h2>
            <form id="login-form">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
                <button type="submit">Iniciar Sessió</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const sheetId = '1OHGZn1a5yr6AmPPLiy_vW30whbejsKyWTFgSSxRrzgY';
        const apiKey = 'AIzaSyA6Nj2FGa-Vsom8HRPZxNlQQ3rE7PSLqPQ';
        const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/A1:G26?key=${apiKey}`;

        // Funció per obrir el modal d'inici de sessió
        document.getElementById('login-btn').addEventListener('click', () => {
            document.getElementById('login-modal').style.display = 'flex';
        });

        // Funció per tancar el modal d'inici de sessió
        document.getElementById('login-modal').addEventListener('click', (event) => {
            if (event.target.id === 'login-modal') {
                document.getElementById('login-modal').style.display = 'none';
            }
        });

        // Funció per processar l'inici de sessió
        document.getElementById('login-form').addEventListener('submit', (event) => {
            event.preventDefault();
            const email = document.getElementById('email').value;

            // Guarda l'email en localStorage
            localStorage.setItem('userEmail', email);
            console.log('Usuari iniciat sessió amb email:', email);

            // Tanca el modal
            document.getElementById('login-modal').style.display = 'none';

            // Carrega el qüestionari
            loadQuiz();
        });

        // Funció per carregar el qüestionari
        function loadQuiz() {
            fetch(sheetUrl)
                .then(response => response.json())
                .then(data => {
                    const rows = data.values.slice(1); // Eliminem capçalera
                    
                    // Verificació d'estructura
                    rows.forEach((row, index) => {
                        if (row.length < 7) {
                            console.error(`Falta data a la pregunta ${index + 1}:`, row);
                            throw new Error(`Pregunta ${index + 1} mal formada`);
                        }
                    });

                    // Seleccionem 25 fileres aleatòries
                    const randomRows = selectRandomRows(rows, 25);

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('quiz-container').style.display = 'block';
                    document.getElementById('submit-btn').style.display = 'block';
                    
                    generateQuiz(randomRows);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('quiz-container').innerHTML = 
                        `<p style="color: red;">Error carregant dades: ${error.message}</p>`;
                });
        }

        // Funció per seleccionar 25 fileres aleatòries
        function selectRandomRows(rows, count) {
            const shuffled = rows.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // Funció per generar el qüestionari
        function generateQuiz(rows) {
            const container = document.getElementById('quiz-container');
            container.innerHTML = rows.map((row, index) => {
                const [question, A, B, C, D, correcta, explicacio] = row;
                return `
                    <div class="question">
                        <h3>${index + 1}. ${question}</h3>
                        <div class="options">
                            ${['A','B','C','D'].map(lletra => `
                                <label>
                                    <input type="radio" name="q${index}" value="${lletra}">
                                    ${row[['A','B','C','D'].indexOf(lletra) + 1]}
                                </label>
                            `).join('')}
                        </div>
                        <div class="result" id="result-${index}"></div>
                        <div class="explanation" id="explanation-${index}"></div>
                    </div>
                `;
            }).join('');

            document.getElementById('submit-btn').onclick = () => verifyAnswers(rows);
        }

        // Funció per verificar les respostes
        function verifyAnswers(rows) {
            let correctes = 0;
            rows.forEach((row, index) => {
                const correcta = extractLetter(row[5].trim().toUpperCase()); // Extrae solo la letra de la respuesta correcta
                const seleccionada = document.querySelector(`input[name="q${index}"]:checked`)?.value.toUpperCase() || '';
                
                const resultDiv = document.getElementById(`result-${index}`);
                const explanationDiv = document.getElementById(`explanation-${index}`);

                if (seleccionada === correcta) {
                    resultDiv.innerHTML = '<span class="correct">✓ Correcte</span>';
                    correctes++;
                } else {
                    resultDiv.innerHTML = `
                        <span class="incorrect">✗ Incorrecte</span>
                        <br><small>Resposta correcta: ${row[5]}</small>
                    `;
                    explanationDiv.innerHTML = row[6] || 'Sense explicació';
                }
            });

            const total = rows.length;
            const percentage = Math.round((correctes / total) * 100);

            let percentageColorClass = 'green';
            if (percentage < 50) {
                percentageColorClass = 'red';
            } else if (percentage >= 51 && percentage <= 59) {
                percentageColorClass = 'brown';
            }

            document.getElementById('results').innerHTML = `
                <h2>Resultat: ${correctes}/${total}</h2>
                <p>Percentatge d'èxit: <span class="bold ${percentageColorClass}">${percentage}%</span></p>
            `;

            // Guarda els resultats de l'usuari
            saveResults(correctes, total);
        }

        // Funció per extreure la lletra de la resposta correcta
        function extractLetter(answer) {
            return answer.match(/[A-D]/)[0]; // Extrae la primera lletra que sea A, B, C o D
        }

        // Funció per guardar els resultats de l'usuari
        function saveResults(correctes, total) {
            const email = localStorage.getItem('userEmail');
            if (email) {
                const progressData = JSON.parse(localStorage.getItem('userProgress')) || {};
                const currentDate = new Date().toISOString().split('T')[0];
                progressData[currentDate] = (correctes / total) * 100;
                localStorage.setItem('userProgress', JSON.stringify(progressData));
                console.log('Guardant resultats per a:', email, 'Correctes:', correctes, 'Total:', total);
            } else {
                console.error('No s\'ha iniciat sessió');
            }
        }

        // Funció per mostrar el progrés
        document.getElementById('show-progress-btn').addEventListener('click', () => {
            const email = localStorage.getItem('userEmail');
            if (email) {
                const progressData = JSON.parse(localStorage.getItem('userProgress')) || {};
                const dates = Object.keys(progressData);
                const percentages = Object.values(progressData);

                const ctx = document.getElementById('progressChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Progrés d\'encerts (%)',
                            data: percentages,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Percentatge d\'encerts (%)'
                                }
                            }
                        }
                    }
                });

                document.getElementById('progress-chart').style.display = 'block';
            } else {
                alert('Debes iniciar sesión para ver tu progreso.');
            }
        });

        // Carrega el qüestionari quan la pàgina es carrega
        document.addEventListener('DOMContentLoaded', loadQuiz);

        // Funció per refrescar la pàgina
        document.getElementById('refresh-btn').addEventListener('click', () => {
            location.reload(); // Refresca la pàgina
        });
    </script>
</body>
</html>
